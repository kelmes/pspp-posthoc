AT_BANNER([files handling])

AT_SETUP([Write error - directory exists])

mkdir foobar.sav

AT_DATA([file.sps], [dnl
DATA LIST NOTABLE/x 1.
BEGIN DATA.
5
END DATA.
SAVE OUTFILE='foobar.sav'.
])

AT_CHECK([pspp -O format=csv file.sps], [1], [dnl
error: Opening foobar.sav for writing: Is a directory.

error: Error opening `foobar.sav' for writing as a system file: Is a directory.
])

AT_CLEANUP


AT_SETUP([Write error - no permission])

mkdir  directory
touch directory/foobar.sav
chmod 000 directory

AT_DATA([file.sps], [dnl
DATA LIST NOTABLE/x 1.
BEGIN DATA.
5
END DATA.
SAVE OUTFILE='directory/foobar.sav'.
])

AT_CHECK([pspp -O format=csv file.sps], [1], [dnl
error: Creating temporary file to replace directory/foobar.sav: Permission denied.

error: Error opening `directory/foobar.sav' for writing as a system file: Permission denied.
])

chmod 700 directory

AT_CLEANUP



AT_SETUP([Write error - temp file disappeared])

AT_DATA([file.sps], [dnl
DATA LIST NOTABLE/x 1.
BEGIN DATA.
5
END DATA.
XSAVE OUTFILE='foobar.sav'.
HOST COMMAND=[['rm foobar.savtmp*']].
EXECUTE.
])

AT_CHECK([pspp -O format=csv file.sps], [1], [ignore])

AT_CLEANUP



AT_SETUP([Write fifo])

dnl The Fifo feature is not available in w32 builds
AT_SKIP_IF([case $host in *-*-mingw*) true ;; *) false ;; esac])

AT_DATA([file.sps], [dnl
DATA LIST NOTABLE/x 1.
BEGIN DATA.
5
END DATA.
SAVE OUTFILE='foobar.sav'.
])

mkfifo foobar.sav
cat foobar.sav > /dev/null & 
pid=$!

AT_CHECK([pspp -O format=csv file.sps], [0], [ignore])

AT_CLEANUP



AT_SETUP([Reading from pipe])

AT_DATA([pipe.sps], [dnl
data list file='printf "1 2\n 3 4\n 5 6\n" |' notable list /x * y *.
list.
])

AT_CHECK([pspp -O format=csv pipe.sps], [0], [dnl
Table: Data List
x,y
1.00,2.00
3.00,4.00
5.00,6.00
])

AT_CLEANUP
